---
import Default from "@astrojs/starlight/components/PageSidebar.astro";
import type { Props } from '@astrojs/starlight/props';
import config from 'virtual:starlight-site-graph/config'
import micromatch from 'micromatch';
import Graph from "../components/Graph.astro";

const graphData: {
    hidden?: boolean;
    depth?: number;
} | undefined = Astro.props.entry['data'].graph;


let showGraph: boolean;
if (graphData?.hidden !== undefined) {
    showGraph = graphData.hidden;
} else {
    showGraph = true;
    if (config.graphVisibilityRules) {
        for (const pattern of config.graphVisibilityRules) {
            if (pattern === "")  {
                showGraph = Astro.props.slug === '';
                break;
            }

            const negated = pattern.startsWith('!');
            if (micromatch.isMatch(Astro.props.slug, negated ? pattern.slice(1) : pattern)) {
                showGraph = !negated;
                break;
            }
        }
    }
}
---

{showGraph &&
    <div class="right-sidebar-panel graph-panel">
        <h2>Graph View</h2>
        <Graph sitemap={config.sitemap} config={{
            ...config.graphConfig,
            depth: graphData?.depth ?? config.graphConfig.depth,
        }} />
    </div>
}

<Default {...Astro.props}>
    <slot />
</Default>
