---
import path from 'node:path';
import type { Props } from '@astrojs/starlight/props';
import type { PageGraphConfig } from "../../schema";

import config from 'virtual:starlight-site-graph/config';
import astroConfig from 'virtual:starlight-site-graph/astro-config';

import Graph from "./Graph.astro";

import { stripSlashes } from '../util';
import { firstMatchingPattern } from "../../sitemap/util";

const graphData: PageGraphConfig | undefined = Astro.props.entry['data'].graph;

interface CurrentProps extends Props {
    class: string;
    showGraph?: boolean;
}

let { slug, showGraph, class: className } = Astro.props as CurrentProps;

if (showGraph === undefined) {
    if (graphData?.visible !== undefined) {
        showGraph = graphData.visible;
    } else {
        showGraph = config.graphConfig.visibilityRules ? firstMatchingPattern(slug, config.graphConfig.visibilityRules, false) : true;
    }
}

const slugWithBase = stripSlashes(path.join(astroConfig.base, slug).replaceAll("\\", "/"));
---

{showGraph &&
    <div class:list={className}>
        <slot name="title"/>
        <Graph
            slug={slugWithBase}
            sitemap={import.meta.env.DEV ? config.sitemapConfig.sitemap : {}}
            config={{
                ...config.graphConfig,
                ...graphData
            }}
            debug={config.debug}
        />
    </div>
}

<script>
    window.addEventListener('DOMContentLoaded', async () => {
        if (import.meta.env.PROD) {
            const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 1));
            onIdle(async () => {
                const sitemap = await (await fetch(import.meta.env.BASE_URL + 'sitegraph/sitemap.json')).json();
                const sitemap_string = JSON.stringify(sitemap);
                document.querySelectorAll('graph-component').forEach((graph) => {
                    if (graph.getAttribute('data-sitemap') === '{}') {
                        graph.setAttribute('data-sitemap', sitemap_string);
                    }
                });
            });
        }
    });
</script>
